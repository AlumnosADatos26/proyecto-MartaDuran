<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Buscar películas</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <!-- barra de busqueda principal -->
  <ion-searchbar [(ngModel)]="nombrePeli" placeholder="Busca por título de película" (ionInput)="onSearchInput()"
    debounce="500">
  </ion-searchbar>

  <!-- btn para mostrar/ocultar filtros -->
  <ion-button expand="block" fill="outline" (click)="toggleFilters()">
    <ion-icon name="filter-outline" slot="start"></ion-icon>
    {{ showFilters ? 'Ocultar filtros' : 'Mostrar filtros' }}
  </ion-button>

  <!-- panel de filtros -->
  <div *ngIf="showFilters" class="filters-container">

    <!-- GENERO -->
    <p class="filter-title">Género</p>
    <div class="chips-row">
      <ion-chip *ngFor="let genre of genres"
        [class.active]="selectedGenre === genre.id"
        (click)="toggleGenre(genre.id)">
        {{ genre.name }}
      </ion-chip>
    </div>

    <!-- MOOD -->
    <p class="filter-title">Estado de ánimo</p>
    <div class="chips-row">
      <ion-chip *ngFor="let mood of ['feliz','triste','emocionado','relajado','miedo']"
        [class.active]="selectedMood === mood"
        (click)="toggleMood(mood)">
        {{ mood }}
      </ion-chip>
    </div>

    <!-- DURACIon -->
    <p class="filter-title">Duración</p>
    <div class="chips-row">
      <ion-chip [class.active]="selectedDuration === 'corta'" (click)="toggleDuration('corta')">
        Corta (&lt;90 min)
      </ion-chip>
      <ion-chip [class.active]="selectedDuration === 'media'" (click)="toggleDuration('media')">
        Media (90-120 min)
      </ion-chip>
      <ion-chip [class.active]="selectedDuration === 'larga'" (click)="toggleDuration('larga')">
        Larga (&gt;120 min)
      </ion-chip>
    </div>

    <ion-button expand="block" fill="clear" (click)="clearFilters()">
      Limpiar filtros
    </ion-button>

  </div>

  <!-- Indicador de carga -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner></ion-spinner>
    <p>Buscando películas...</p>
  </div>

  <!-- Mensaje cuando no hay resultados -->
  <div *ngIf="searching && peliculas.length === 0 && !isLoading" class="no-results">
    <ion-icon name="film-outline" size="large"></ion-icon>
    <p>No se encontraron películas.</p>
    <p class="hint">Intenta con otros términos o filtros</p>
  </div>

  <!-- Resultados -->
  <div *ngIf="peliculas.length > 0" class="results-header">
    <p>{{ peliculas.length }} resultado{{ peliculas.length !== 1 ? 's' : '' }}</p>
  </div>

  <ion-grid *ngIf="peliculas.length > 0">
    <ion-row>
      <ion-col size="6" size-md="4" size-lg="3" *ngFor="let peli of peliculas">
        <ion-card (click)="verFicha(peli)" class="movie-card">
          <div class="poster-container">
            <img [src]="getImageUrl(peli.poster_path)" [alt]="peli.title">
            <div class="rating-badge" *ngIf="peli.vote_average >= 0">
              <ion-icon name="star"></ion-icon>
              ⭐ {{ peli.vote_average | number:'1.1-1' }}
            </div>
          </div>
          <ion-card-header>
            <ion-card-title>{{ peli.title }}</ion-card-title>
            <ion-chip class="year-badge">
              {{ peli.release_date ? peli.release_date.split('-')[0] : '---' }}
            </ion-chip>
          </ion-card-header>
        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>

  <ion-infinite-scroll
    threshold="100px"
    (ionInfinite)="loadMore($event)"
    *ngIf="currentPage < totalPages">

    <ion-infinite-scroll-content
      loadingSpinner="crescent"
      loadingText="Cargando más películas...">
    </ion-infinite-scroll-content>

  </ion-infinite-scroll>

</ion-content>